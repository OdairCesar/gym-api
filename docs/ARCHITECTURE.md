# ğŸ—ï¸ Arquitetura e Fluxograma - Gym API

DocumentaÃ§Ã£o visual da arquitetura e fluxos da aplicaÃ§Ã£o.

---

## ğŸ“ Arquitetura Geral

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENTE                              â”‚
â”‚                    (Mobile/Web App)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ HTTPS
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    NGINX (Reverse Proxy)                     â”‚
â”‚  â€¢ SSL/TLS Termination                                       â”‚
â”‚  â€¢ Rate Limiting (Adicional)                                 â”‚
â”‚  â€¢ Load Balancing                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   GYM API (AdonisJS)                         â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              MIDDLEWARE LAYER                        â”‚   â”‚
â”‚  â”‚  â€¢ ForceJsonResponse                                 â”‚   â”‚
â”‚  â”‚  â€¢ ContainerBindings                                 â”‚   â”‚
â”‚  â”‚  â€¢ Auth (Bearer Token)                               â”‚   â”‚
â”‚  â”‚  â€¢ Rate Limiting (@adonisjs/limiter)                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                       â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              ROUTES LAYER                            â”‚   â”‚
â”‚  â”‚  â€¢ /auth/*                                           â”‚   â”‚
â”‚  â”‚  â€¢ /users/*                                          â”‚   â”‚
â”‚  â”‚  â€¢ /diets/*  /trainings/*                            â”‚   â”‚
â”‚  â”‚  â€¢ /products/*  /gyms/*                              â”‚   â”‚
â”‚  â”‚  â€¢ /gym-permissions/*  /user-permissions/*           â”‚   â”‚
â”‚  â”‚  â€¢ /gym-plans/* (pÃºblico)                            â”‚   â”‚
â”‚  â”‚  â€¢ /gym-subscriptions/* (autenticado)                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                       â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚            CONTROLLERS LAYER                         â”‚   â”‚
â”‚  â”‚  â€¢ AuthController                                    â”‚   â”‚
â”‚  â”‚  â€¢ UsersController                                   â”‚   â”‚
â”‚  â”‚  â€¢ DietsController, MealsController, FoodsController â”‚   â”‚
â”‚  â”‚  â€¢ TrainingsController, ExercisesController          â”‚   â”‚
â”‚  â”‚  â€¢ ProductsController, GymsController                â”‚   â”‚
â”‚  â”‚  â€¢ GympermissionsController, UserpermissionsControllerâ”‚  â”‚
â”‚  â”‚  â€¢ GymplansController, UserpermissionsControllers    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                       â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           AUTHORIZATION LAYER                        â”‚   â”‚
â”‚  â”‚  â€¢ Bouncer (Policy-based)                            â”‚   â”‚
â”‚  â”‚  â€¢ UserPolicy, DietPolicy, TrainingPolicy            â”‚   â”‚
â”‚  â”‚  â€¢ ProductPolicy, GymPolicy, PermissionPolicy        â”‚   â”‚
â”‚  â”‚  â€¢ SubscriptionPolicy (admin/super)                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                       â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              MODELS LAYER                            â”‚   â”‚
â”‚  â”‚  â€¢ User, Gym, AccessToken                            â”‚   â”‚
â”‚  â”‚  â€¢ Diet, Meal, Food                                  â”‚   â”‚
â”‚  â”‚  â€¢ Training, Exercise (many-to-many)                 â”‚   â”‚
â”‚  â”‚  â€¢ Product, Gympermission, Userpermission            â”‚   â”‚
â”‚  â”‚  â€¢ Gymplan, Gymsubscription                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                       â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚            SERVICES LAYER                            â”‚   â”‚
â”‚  â”‚  â€¢ PermissionService (cross-tenant logic)            â”‚   â”‚
â”‚  â”‚  â€¢ ErrorMonitoring (Sentry/None)              â”‚   â”‚
â”‚  â”‚  â€¢ PaymentService (subscriptions orchestrator)       â”‚   â”‚
â”‚  â”‚  â€¢ PlanLimitService (resource limits validation)     â”‚   â”‚
â”‚  â”‚                                                       â”‚   â”‚
â”‚  â”‚  Payment Strategies (Strategy + Registry):           â”‚   â”‚
â”‚  â”‚  â€¢ PaymentFactory (registry)                         â”‚   â”‚
â”‚  â”‚  â€¢ FreePlanStrategy, GooglePayStrategy, ApplePayStrategyâ”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MySQL Database                            â”‚
â”‚  â€¢ Multi-tenant (logical isolation via gym_id)               â”‚
â”‚  â€¢ Tables: users, gyms, diets, trainings, products, etc.     â”‚
â”‚  â€¢ Rate limiting table                                       â”‚
â”‚  â€¢ Payment tables: gymplans, gymsubscriptions              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  EXTERNAL SERVICES                            â”‚
â”‚  â€¢ Sentry (Error Monitoring) - Opcional                       â”‚
â”‚  â€¢ Redis (Cache - Futuro) - Opcional                          â”‚
â”‚  â€¢ Google Pay API - Payment Provider (Mock em dev)            â”‚
â”‚  â€¢ Apple Pay API - Payment Provider (Mock em dev)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ï¿½ Fluxo de Pagamento (Planos e Assinaturas)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Admin/  â”‚                                              â”‚   API    â”‚
â”‚  Gym     â”‚                                              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                   â”‚
     â”‚                                                          â”‚
     â”‚  POST /gym-subscriptions                                â”‚
     â”‚  Header: Authorization: Bearer <token>                  â”‚
     â”‚  Body: {                                                â”‚
     â”‚    plan_slug: "intermediate",                           â”‚
     â”‚    payment_method: "google_pay",                        â”‚
     â”‚    payment_data: {token: "gp_xxx"}                      â”‚
     â”‚  }                                                       â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶
     â”‚                                                          â”‚
     â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
     â”‚         â”‚ 1. Auth Middleware                â”‚           â”‚
     â”‚         â”‚    â€¢ Verify Token                 â”‚           â”‚
     â”‚         â”‚    â€¢ Load User (Admin)            â”‚           â”‚
     â”‚         â”‚                                   â”‚           â”‚
     â”‚         â”‚ 2. Validator                      â”‚           â”‚
     â”‚         â”‚    â€¢ plan_slug required           â”‚           â”‚
     â”‚         â”‚    â€¢ payment_method required      â”‚           â”‚
     â”‚         â”‚                                   â”‚           â”‚
     â”‚         â”‚ 3. Controller                     â”‚           â”‚
     â”‚         â”‚    â€¢ UserpermissionsControllers   â”‚           â”‚
     â”‚         â”‚    â€¢ validatePlanPaymentCombination()        â”‚
     â”‚         â”‚      - Free plan â†’ 'free' only    â”‚           â”‚
     â”‚         â”‚      - Paid plans â†’ not 'free'    â”‚           â”‚
     â”‚         â”‚                                   â”‚           â”‚
     â”‚         â”‚ 4. PaymentService.subscribe()     â”‚           â”‚
     â”‚         â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚           â”‚
     â”‚         â”‚    â”‚ TRANSACTION START        â”‚  â”‚           â”‚
     â”‚         â”‚    â”‚                          â”‚  â”‚           â”‚
     â”‚         â”‚    â”‚ a) Find old subscriptionâ”‚  â”‚           â”‚
     â”‚         â”‚    â”‚    set status='cancelled'â”‚  â”‚           â”‚
     â”‚         â”‚    â”‚                          â”‚  â”‚           â”‚
     â”‚         â”‚    â”‚ b) PaymentFactory.createâ”‚  â”‚           â”‚
     â”‚         â”‚    â”‚    'google_pay'          â”‚  â”‚           â”‚
     â”‚         â”‚    â”‚    â†“                     â”‚  â”‚           â”‚
     â”‚         â”‚    â”‚  GooglePayStrategy       â”‚  â”‚           â”‚
     â”‚         â”‚    â”‚    â†“                     â”‚  â”‚           â”‚
     â”‚         â”‚    â”‚  processPayment()        â”‚  â”‚           â”‚
     â”‚         â”‚    â”‚    â€¢ validate token      â”‚  â”‚           â”‚
     â”‚         â”‚    â”‚    â€¢ call Google Pay API â”‚  â”‚           â”‚
     â”‚         â”‚    â”‚      (mock em dev)       â”‚  â”‚           â”‚
     â”‚         â”‚    â”‚    â€¢ return result       â”‚  â”‚           â”‚
     â”‚         â”‚    â”‚                          â”‚  â”‚           â”‚
     â”‚         â”‚    â”‚ c) Create Gymsubscriptionâ”‚  â”‚           â”‚
     â”‚         â”‚    â”‚    â€¢ status: 'active'    â”‚  â”‚           â”‚
     â”‚         â”‚    â”‚    â€¢ payment_provider_id â”‚  â”‚           â”‚
     â”‚         â”‚    â”‚    â€¢ started_at: now()   â”‚  â”‚           â”‚
     â”‚         â”‚    â”‚    â€¢ ends_at: +30 days   â”‚  â”‚           â”‚
     â”‚         â”‚    â”‚                          â”‚  â”‚           â”‚
     â”‚         â”‚    â”‚ TRANSACTION COMMIT       â”‚  â”‚           â”‚
     â”‚         â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚           â”‚
     â”‚         â”‚                                   â”‚           â”‚
     â”‚         â”‚ 5. Return subscription           â”‚           â”‚
     â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
     â”‚                                                          â”‚
     â”‚  201 Created                                             â”‚
     â”‚  {                                                       â”‚
     â”‚    id: 15,                                              â”‚
     â”‚    gym_id: 3,                                           â”‚
     â”‚    plan_id: 2,                                          â”‚
     â”‚    status: "active",                                    â”‚
     â”‚    payment_method: "google_pay",                        â”‚
     â”‚    payment_provider_id: "gp_xxx",                       â”‚
     â”‚    started_at: "2024-01-20T10:00:00Z",                  â”‚
     â”‚    ends_at: "2024-02-20T10:00:00Z"                      â”‚
     â”‚  }                                                       â”‚
     â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                          â”‚
     â”‚                                                          â”‚
     â”‚  POST /users (criar usuÃ¡rio apÃ³s upgrade)               â”‚
     â”‚  Body: {name, email, gym_id, ...}                       â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶
     â”‚                                                          â”‚
     â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
     â”‚         â”‚ 1. UsersController                â”‚           â”‚
     â”‚         â”‚    â†“                               â”‚           â”‚
     â”‚         â”‚ 2. PlanLimitService.canAddUser()  â”‚           â”‚
     â”‚         â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚           â”‚
     â”‚         â”‚    â”‚ a) Load gym + subscription â”‚ â”‚           â”‚
     â”‚         â”‚    â”‚    + plan                  â”‚ â”‚           â”‚
     â”‚         â”‚    â”‚                            â”‚ â”‚           â”‚
     â”‚         â”‚    â”‚ b) Count existing users    â”‚ â”‚           â”‚
     â”‚         â”‚    â”‚    WHERE gym_id = X        â”‚ â”‚           â”‚
     â”‚         â”‚    â”‚                            â”‚ â”‚           â”‚
     â”‚         â”‚    â”‚ c) Check limit:            â”‚ â”‚           â”‚
     â”‚         â”‚    â”‚    if plan.max_users=null  â”‚ â”‚           â”‚
     â”‚         â”‚    â”‚      â†’ always OK (unlimited)â”‚ â”‚           â”‚
     â”‚         â”‚    â”‚    else if count < max     â”‚ â”‚           â”‚
     â”‚         â”‚    â”‚      â†’ OK                  â”‚ â”‚           â”‚
     â”‚         â”‚    â”‚    else                    â”‚ â”‚           â”‚
     â”‚         â”‚    â”‚      â†’ throw LimitReached  â”‚ â”‚           â”‚
     â”‚         â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚           â”‚
     â”‚         â”‚                                   â”‚           â”‚
     â”‚         â”‚ 3. Create User                    â”‚           â”‚
     â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
     â”‚                                                          â”‚
     â”‚  201 Created                                             â”‚
     â”‚  {id, name, email, gym_id, ...}                         â”‚
     â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                          â”‚


Fluxo de ValidaÃ§Ã£o de Limite (Diagrama):

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UsersController â”‚
â”‚   store()       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PlanLimitService           â”‚
â”‚  canAddUser(gym_id)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Load Gym with Subscription â”‚â”€â”€â”€â”€â–¶â”‚ Database    â”‚
â”‚ and Plan (eager loading)   â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Count Users                â”‚
â”‚ WHERE gym_id = ?           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Check Plan Type            â”‚
â”‚ â€¢ Unlimited (max_users=null)
â”‚   â†’ return true            â”‚
â”‚ â€¢ Limited                  â”‚
â”‚   â†’ compare count vs limit â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€ count < max_users â”€â”€â–¶ return true
         â”‚
         â””â”€ count >= max_users â”€â–¶ throw LimitReachedException
                                   â†“
                                 403 Forbidden
```

### EstratÃ©gias de Pagamento (Strategy Pattern)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Payment                          â”‚
â”‚                      (Interface)                             â”‚
â”‚                                                              â”‚
â”‚  + processPayment(data): Promise<PaymentResult>              â”‚
â”‚  + validatePaymentData(data): boolean                       â”‚
â”‚  + refund(subscriptionId): Promise<RefundResult>             â”‚
â”‚  + isConfigured(): boolean                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚            â”‚                â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Free     â”‚  â”‚  Google    â”‚  â”‚    Apple        â”‚
    â”‚  Plan      â”‚  â”‚   Pay      â”‚  â”‚     Pay         â”‚
    â”‚ Strategy   â”‚  â”‚ Strategy   â”‚  â”‚   Strategy      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                â”‚                 â”‚
         â”‚                â”‚                 â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  PaymentFactory      â”‚
              â”‚   (Registry)         â”‚
              â”‚                      â”‚
              â”‚ strategies = Map(    â”‚
              â”‚   'free' â†’ Strategy, â”‚
              â”‚   'google_pay' â†’ ... â”‚
              â”‚   'apple_pay' â†’ ...  â”‚
              â”‚ )                    â”‚
              â”‚                      â”‚
              â”‚ create(method)       â”‚
              â”‚ getSupportedMethods()â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Uso:
const factory = PaymentFactory
const strategy = factory.create('google_pay')
const result = await strategy.processPayment(data)
```

---

## ï¿½ğŸ” Fluxo de AutenticaÃ§Ã£o

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client  â”‚                                              â”‚   API    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                                                          â”‚
     â”‚  POST /auth/register                                    â”‚
     â”‚  {email, password, name, gym_id, role}                  â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶
     â”‚                                                          â”‚
     â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
     â”‚                      â”‚ 1. Validate Data    â”‚            â”‚
     â”‚                      â”‚ 2. Hash Password    â”‚            â”‚
     â”‚                      â”‚ 3. Create User      â”‚            â”‚
     â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
     â”‚                                                          â”‚
     â”‚  201 Created                                             â”‚
     â”‚  {user: {...}, token: {...}}                            â”‚
     â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                          â”‚
     â”‚  POST /auth/login                                        â”‚
     â”‚  {email, password}                                       â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶
     â”‚                                                          â”‚
     â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
     â”‚                      â”‚ 1. Rate Limit Check â”‚            â”‚
     â”‚                      â”‚    (5 req/min)      â”‚            â”‚
     â”‚                      â”‚ 2. Find User        â”‚            â”‚
     â”‚                      â”‚ 3. Verify Password  â”‚            â”‚
     â”‚                      â”‚ 4. Generate Token   â”‚            â”‚
     â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
     â”‚                                                          â”‚
     â”‚  200 OK                                                  â”‚
     â”‚  {user: {...}, token: {token, type: 'bearer'}}          â”‚
     â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                          â”‚
     â”‚  GET /auth/me                                            â”‚
     â”‚  Header: Authorization: Bearer <token>                   â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶
     â”‚                                                          â”‚
     â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
     â”‚                      â”‚ 1. Verify Token     â”‚            â”‚
     â”‚                      â”‚ 2. Load User        â”‚            â”‚
     â”‚                      â”‚ 3. Return User Data â”‚            â”‚
     â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
     â”‚                                                          â”‚
     â”‚  200 OK                                                  â”‚
     â”‚  {user: {...}}                                          â”‚
     â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                          â”‚
     â”‚  POST /auth/logout                                       â”‚
     â”‚  Header: Authorization: Bearer <token>                   â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶
     â”‚                                                          â”‚
     â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
     â”‚                      â”‚ 1. Verify Token     â”‚            â”‚
     â”‚                      â”‚ 2. Delete Token     â”‚            â”‚
     â”‚                      â”‚    from Database    â”‚            â”‚
     â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
     â”‚                                                          â”‚
     â”‚  200 OK                                                  â”‚
     â”‚  {message: 'Logged out successfully'}                   â”‚
     â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                          â”‚
```

---

## ğŸ‹ï¸ Fluxo de CriaÃ§Ã£o de Treino (Multi-tenant)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Personal â”‚                                              â”‚   API    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                                                          â”‚
     â”‚  POST /trainings                                         â”‚
     â”‚  Header: Authorization: Bearer <token>                   â”‚
     â”‚  Body: {name, client_id, gym_id, observations}           â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶
     â”‚                                                          â”‚
     â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
     â”‚              â”‚ 1. Auth Middleware             â”‚          â”‚
     â”‚              â”‚    â€¢ Verify Token              â”‚          â”‚
     â”‚              â”‚    â€¢ Load User (Personal)      â”‚          â”‚
     â”‚              â”‚                                â”‚          â”‚
     â”‚              â”‚ 2. Rate Limiting               â”‚          â”‚
     â”‚              â”‚    â€¢ Check: 100 req/min        â”‚          â”‚
     â”‚              â”‚                                â”‚          â”‚
     â”‚              â”‚ 3. Validator                   â”‚          â”‚
     â”‚              â”‚    â€¢ Required fields           â”‚          â”‚
     â”‚              â”‚    â€¢ Data types                â”‚          â”‚
     â”‚              â”‚                                â”‚          â”‚
     â”‚              â”‚ 4. Controller                  â”‚          â”‚
     â”‚              â”‚    â€¢ TrainingsController       â”‚          â”‚
     â”‚              â”‚                                â”‚          â”‚
     â”‚              â”‚ 5. Policy Check                â”‚          â”‚
     â”‚              â”‚    â€¢ Can create training?      â”‚          â”‚
     â”‚              â”‚    â€¢ Same gym as personal?     â”‚          â”‚
     â”‚              â”‚    â€¢ Client exists in gym?     â”‚          â”‚
     â”‚              â”‚                                â”‚          â”‚
     â”‚              â”‚ 6. Database                    â”‚          â”‚
     â”‚              â”‚    â€¢ INSERT INTO trainings     â”‚          â”‚
     â”‚              â”‚    â€¢ Multi-tenant via gym_id   â”‚          â”‚
     â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
     â”‚                                                          â”‚
     â”‚  201 Created                                             â”‚
     â”‚  {id, name, client_id, gym_id, ...}                     â”‚
     â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                          â”‚
     â”‚  POST /trainings/:id/exercises                           â”‚
     â”‚  Body: {exercise_id, series, repetitions, weight, ...}   â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶
     â”‚                                                          â”‚
     â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
     â”‚              â”‚ 1. Verify ownership            â”‚          â”‚
     â”‚              â”‚    â€¢ Training belongs to gym?  â”‚          â”‚
     â”‚              â”‚                                â”‚          â”‚
     â”‚              â”‚ 2. Insert Pivot Table          â”‚          â”‚
     â”‚              â”‚    â€¢ exercise_training table   â”‚          â”‚
     â”‚              â”‚    â€¢ Custom data: series, reps â”‚          â”‚
     â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
     â”‚                                                          â”‚
     â”‚  200 OK                                                  â”‚
     â”‚  {training: {...}, exercises: [...]}                    â”‚
     â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                          â”‚
```

---

## ğŸ¥— Fluxo de Dietas (Nested Resources)

```
Diet (Dieta)
  â”‚
  â”œâ”€â”€â”€ Meal (RefeiÃ§Ã£o 1) - CafÃ© da ManhÃ£
  â”‚      â”œâ”€â”€â”€ Food (Alimento 1) - Aveia
  â”‚      â”œâ”€â”€â”€ Food (Alimento 2) - Banana
  â”‚      â””â”€â”€â”€ Food (Alimento 3) - Mel
  â”‚
  â”œâ”€â”€â”€ Meal (RefeiÃ§Ã£o 2) - AlmoÃ§o
  â”‚      â”œâ”€â”€â”€ Food (Alimento 1) - Arroz
  â”‚      â”œâ”€â”€â”€ Food (Alimento 2) - Frango
  â”‚      â””â”€â”€â”€ Food (Alimento 3) - Salada
  â”‚
  â””â”€â”€â”€ Meal (RefeiÃ§Ã£o 3) - Jantar
         â”œâ”€â”€â”€ Food (Alimento 1) - Peixe
         â””â”€â”€â”€ Food (Alimento 2) - Legumes

Rotas:
POST   /diets                          # Criar dieta
POST   /diets/:dietId/meals            # Criar refeiÃ§Ã£o na dieta
POST   /meals/:mealId/foods            # Criar alimento na refeiÃ§Ã£o
GET    /diets/:id                      # Ver dieta completa (eager loading)
```

---

## ğŸ”‘ Fluxo de PermissÃµes Cross-Tenant

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CENÃRIO 1: GYM PERMISSION                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Academia A                              Academia B
(owner_gym_id: 1)                       (granted_gym_id: 2)
     â”‚                                        â”‚
     â””â”€â”€â”€â”€â”€â”€ concede permissÃ£o â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶
                 personal_id: 5
                 can_edit_diets: true
                 can_edit_trainings: true

Resultado:
â€¢ Personal (id: 5) pode acessar recursos da Academia B
â€¢ Pode criar/editar treinos e dietas para clientes da Academia B
â€¢ Consulta: PermissionService.canAccessGymResource()


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   CENÃRIO 2: USER PERMISSION                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Cliente (user_id: 10, gym_id: 1)
     â”‚
     â””â”€â”€â”€â”€â”€â”€ concede permissÃ£o â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  Personal (grantee_id: 15)
                 grantee_type: 'user'
                 can_edit_diets: true
                 can_edit_trainings: true

Resultado:
â€¢ Personal (id: 15) pode editar DIETA e TREINO do Cliente (id: 10)
â€¢ PermissÃ£o granular: pode ser configurada individualmente
â€¢ Consulta: PermissionService.canEditUserResource()


Fluxo de VerificaÃ§Ã£o:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Request  â”‚ â”€â”€â”€â–¶ â”‚  Policy  â”‚ â”€â”€â”€â–¶ â”‚ Permission   â”‚ â”€â”€â”€â–¶ â”‚ Database â”‚
â”‚          â”‚      â”‚          â”‚      â”‚   Service    â”‚      â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚                    â”‚
                       â”‚                    â”œâ”€ Check Gympermission
                       â”‚                    â”œâ”€ Check Userpermission
                       â”‚                    â””â”€ Return boolean
                       â”‚
                       â””â”€ Allow/Deny access
```

---

## ğŸš¦ Fluxo de Rate Limiting

```
Client Request
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   NGINX Rate Limiting (Opcional)         â”‚
â”‚   â€¢ Primeiro nÃ­vel de proteÃ§Ã£o           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   AdonisJS Limiter Middleware            â”‚
â”‚                                          â”‚
â”‚   1. Identifica chave:                   â”‚
â”‚      â€¢ IP (nÃ£o autenticado)              â”‚
â”‚      â€¢ user_{id} (autenticado)           â”‚
â”‚                                          â”‚
â”‚   2. Consulta database:                  â”‚
â”‚      SELECT * FROM rate_limits           â”‚
â”‚      WHERE key = ? AND expire_at > NOW() â”‚
â”‚                                          â”‚
â”‚   3. Verifica limite:                    â”‚
â”‚      â€¢ authThrottle: 5 req/min           â”‚
â”‚      â€¢ apiThrottle: 100 req/min          â”‚
â”‚      â€¢ publicThrottle: 30 req/min        â”‚
â”‚                                          â”‚
â”‚   4. DecisÃ£o:                            â”‚
â”‚      â”œâ”€ Dentro do limite â”€â”€â–¶ Continua    â”‚
â”‚      â”‚                                    â”‚
â”‚      â””â”€ Excedeu limite â”€â”€â–¶ 429 Response  â”‚
â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Resposta 429:
{
  "errors": [{
    "message": "Too many requests"
  }]
}

Headers:
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 0
X-RateLimit-Reset: 1645123456
Retry-After: 45
```

---

## ğŸ› Fluxo de Error Monitoring

```
Exception Ocorre
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   HttpExceptionHandler                   â”‚
â”‚                                          â”‚
â”‚   report(error, ctx) {                   â”‚
â”‚                                          â”‚
â”‚     1. Captura contexto:                 â”‚
â”‚        â€¢ UsuÃ¡rio autenticado             â”‚
â”‚        â€¢ MÃ©todo e URL da requisiÃ§Ã£o      â”‚
â”‚        â€¢ IP e User-Agent                 â”‚
â”‚        â€¢ Environment                     â”‚
â”‚                                          â”‚
â”‚     2. Remove dados sensÃ­veis:           â”‚
â”‚        â€¢ Authorization headers           â”‚
â”‚        â€¢ Cookies                         â”‚
â”‚                                          â”‚
â”‚     3. Envia para Error Monitoring:      â”‚
â”‚        errorMonitoring.captureException()â”‚
â”‚   }                                      â”‚
â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ErrorMonitoringFactory                 â”‚
â”‚                                          â”‚
â”‚   provider = 'sentry' or 'none'          â”‚
â”‚                                          â”‚
â”‚   â”œâ”€ SentryMonitoringService             â”‚
â”‚   â”‚   â€¢ Envia para Sentry.io             â”‚
â”‚   â”‚   â€¢ Agrega erros similares           â”‚
â”‚   â”‚   â€¢ Contexto rico                    â”‚
â”‚   â”‚                                      â”‚
â”‚   â””â”€ NullMonitoringService               â”‚
â”‚       â€¢ No-op (desenvolvimento/testes)   â”‚
â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Sentry Dashboard                       â”‚
â”‚   â€¢ Visualizar erros                     â”‚
â”‚   â€¢ NotificaÃ§Ãµes                         â”‚
â”‚   â€¢ Stack traces                         â”‚
â”‚   â€¢ AgregaÃ§Ã£o inteligente                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ï¿½ Sistema de ModeraÃ§Ã£o de UsuÃ¡rios

### Hierarquia e Tipos de UsuÃ¡rio

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     SUPER USER                             â”‚
â”‚  â€¢ Gerencia o sistema globalmente                          â”‚
â”‚  â€¢ Pode criar gyms                                         â”‚
â”‚  â€¢ Pode aprovar qualquer usuÃ¡rio de qualquer gym           â”‚
â”‚  â€¢ Sempre pode fazer login (nÃ£o precisa de aprovaÃ§Ã£o)      â”‚
â”‚  â€¢ SÃ³ pode ser criado diretamente no banco de dados        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ADMIN                              â”‚
â”‚  â€¢ Gerencia uma gym especÃ­fica                             â”‚
â”‚  â€¢ Pode aprovar usuÃ¡rios da sua gym                        â”‚
â”‚  â€¢ Pode criar usuÃ¡rios jÃ¡ aprovados na sua gym             â”‚
â”‚  â€¢ Precisa ser aprovado para fazer login                   â”‚
â”‚  â€¢ Isolamento por gym_id                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       PERSONAL                             â”‚
â”‚  â€¢ Pode aprovar usuÃ¡rios da sua gym                        â”‚
â”‚  â€¢ Pode criar usuÃ¡rios jÃ¡ aprovados na sua gym             â”‚
â”‚  â€¢ Gerencia treinos e dietas                               â”‚
â”‚  â€¢ Precisa ser aprovado para fazer login                   â”‚
â”‚  â€¢ Isolamento por gym_id                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CLIENTE                             â”‚
â”‚  â€¢ UsuÃ¡rio final do sistema                                â”‚
â”‚  â€¢ Acessa seus prÃ³prios treinos e dietas                   â”‚
â”‚  â€¢ Precisa ser aprovado para fazer login                   â”‚
â”‚  â€¢ Isolamento por gym_id                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Fluxo de ModeraÃ§Ã£o

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Novo    â”‚                                              â”‚   API    â”‚
â”‚ UsuÃ¡rio  â”‚                                              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                   â”‚
     â”‚                                                          â”‚
     â”‚  POST /auth/register                                    â”‚
     â”‚  {name, email, password, gymId, role}                   â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶
     â”‚                                                          â”‚
     â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
     â”‚              â”‚ 1. Validar dados               â”‚          â”‚
     â”‚              â”‚ 2. Hash password               â”‚          â”‚
     â”‚              â”‚ 3. Create user com:            â”‚          â”‚
     â”‚              â”‚    â€¢ approved = false          â”‚          â”‚
     â”‚              â”‚    â€¢ role informado ou 'user'  â”‚          â”‚
     â”‚              â”‚ 4. Gerar token                 â”‚          â”‚
     â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
     â”‚                                                          â”‚
     â”‚  201 Created                                             â”‚
     â”‚  {message: "Access pending approval", user, token}      â”‚
     â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                          â”‚
     â”‚                                                          â”‚
     â”‚  POST /auth/login                                        â”‚
     â”‚  {email, password}                                       â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶
     â”‚                                                          â”‚
     â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
     â”‚              â”‚ 1. Verificar credenciais       â”‚          â”‚
     â”‚              â”‚ 2. Chamar user.canLogin()      â”‚          â”‚
     â”‚              â”‚    â€¢ Se is_super: true         â”‚          â”‚
     â”‚              â”‚    â€¢ SenÃ£o: verificar approved â”‚          â”‚
     â”‚              â”‚ 3. Se nÃ£o aprovado:            â”‚          â”‚
     â”‚              â”‚    â€¢ Retornar 403 Forbidden    â”‚          â”‚
     â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
     â”‚                                                          â”‚
     â”‚  403 Forbidden                                           â”‚
     â”‚  {message: "Access pending approval. Contact admin"}    â”‚
     â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                          â”‚


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Admin/  â”‚                                              â”‚   API    â”‚
â”‚ Personal â”‚                                              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                   â”‚
     â”‚                                                          â”‚
     â”‚  GET /users/pending-users                               â”‚
     â”‚  Header: Authorization: Bearer <token>                  â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶
     â”‚                                                          â”‚
     â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
     â”‚              â”‚ 1. Verificar se Ã© admin/       â”‚          â”‚
     â”‚              â”‚    personal aprovado ou super  â”‚          â”‚
     â”‚              â”‚ 2. Filtrar por gym_id          â”‚          â”‚
     â”‚              â”‚    (exceto super users)        â”‚          â”‚
     â”‚              â”‚ 3. WHERE approved = false      â”‚          â”‚
     â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
     â”‚                                                          â”‚
     â”‚  200 OK                                                  â”‚
     â”‚  {data: [{id, name, email, gym_id, ...}]}               â”‚
     â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                          â”‚
     â”‚                                                          â”‚
     â”‚  POST /users/{id}/approve-user                          â”‚
     â”‚  Header: Authorization: Bearer <token>                  â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶
     â”‚                                                          â”‚
     â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
     â”‚              â”‚ 1. Verificar permissÃµes        â”‚          â”‚
     â”‚              â”‚    â€¢ Super: pode aprovar todos â”‚          â”‚
     â”‚              â”‚    â€¢ Admin/Personal aprovado:  â”‚          â”‚
     â”‚              â”‚      apenas da mesma gym       â”‚          â”‚
     â”‚              â”‚ 2. Verificar se pendente       â”‚          â”‚
     â”‚              â”‚ 3. UPDATE users SET:           â”‚          â”‚
     â”‚              â”‚    â€¢ approved = true           â”‚          â”‚
     â”‚              â”‚    â€¢ approved_by = current_id  â”‚          â”‚
     â”‚              â”‚    â€¢ approved_at = NOW()       â”‚          â”‚
     â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
     â”‚                                                          â”‚
     â”‚  200 OK                                                  â”‚
     â”‚  {message: "User approved", data: {...}}                â”‚
     â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                          â”‚
     â”‚                                                          â”‚
     â”‚  POST /users/{id}/reject-user                           â”‚
     â”‚  Header: Authorization: Bearer <token>                  â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶
     â”‚                                                          â”‚
     â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
     â”‚              â”‚ 1. Verificar permissÃµes        â”‚          â”‚
     â”‚              â”‚ 2. Verificar se pendente       â”‚          â”‚
     â”‚              â”‚ 3. DELETE user                 â”‚          â”‚
     â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
     â”‚                                                          â”‚
     â”‚  200 OK                                                  â”‚
     â”‚  {message: "User rejected and deleted"}                 â”‚
     â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
```

### Regras de AprovaÃ§Ã£o

| Criador              | User Criado | Status Inicial |
|---------------------|-------------|----------------|
| Sistema (register)   | Qualquer    | `approved = false` |
| Super User          | Qualquer    | `approved = true` |
| Admin aprovado      | Qualquer    | `approved = true` |
| Personal aprovado   | Qualquer    | `approved = true` |
| Admin nÃ£o aprovado  | Qualquer    | `approved = false` |
| Personal nÃ£o aprovado| Qualquer   | `approved = false` |

---

## ï¿½ğŸ’¾ Modelo de Dados (Relacionamentos)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Gym    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚ 1:N
     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                 â”‚                 â”‚                 â”‚               â”‚
     â–¼                 â–¼                 â–¼                 â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User   â”‚      â”‚ Product â”‚      â”‚   Diet   â”‚     â”‚ Training â”‚   â”‚Gymsubscriptionâ”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                  â”‚                 â”‚                â”‚ N:1
     â”‚ 1:N                              â”‚ 1:N             â”‚ 1:N            â”‚
     â”‚                                  â”‚                 â”‚                â–¼
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â–¼                 â–¼          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚              â”‚             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚ Gymplan  â”‚
     â–¼              â–¼             â”‚  Meal   â”‚       â”‚ Exercise â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
â”‚  Diet   â”‚  â”‚   Training   â”‚         â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ 1:N              â”‚ N:M
                                       â”‚                  â”‚
                                       â–¼                  â–¼
                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                 â”‚  Food   â”‚    â”‚ exercise_trainingâ”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  (Pivot Table)  â”‚
                                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Planos e Assinaturas:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Gymplan    â”‚  (3 planos: initial, intermediate, unlimited)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id           â”‚
â”‚ name         â”‚
â”‚ slug         â”‚ â†’ 'initial' | 'intermediate' | 'unlimited'
â”‚ price        â”‚ â†’ decimal(10,2)
â”‚ max_users    â”‚ â†’ number | null (null = ilimitado)
â”‚ features     â”‚ â†’ JSON
â”‚ is_active    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1:N
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Gymsubscription  â”‚  (Cada gym tem uma assinatura ativa)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id               â”‚
â”‚ gym_id           â”‚ â†’ FK to gyms
â”‚ plan_id          â”‚ â†’ FK to gymplans
â”‚ status           â”‚ â†’ 'active' | 'cancelled' | 'past_due'
â”‚ payment_method   â”‚ â†’ 'free' | 'google_pay' | 'apple_pay'
â”‚ payment_provider â”‚
â”‚ payment_provider_idâ”‚
â”‚ payment_metadata â”‚ â†’ JSON
â”‚ started_at       â”‚
â”‚ ends_at          â”‚
â”‚ cancelled_at     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

PermissÃµes Cross-Tenant:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Gympermission   â”‚                    â”‚ Userpermission  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ gym_id          â”‚                    â”‚ user_id         â”‚
â”‚ personal_id     â”‚                    â”‚ grantee_type    â”‚
â”‚ can_edit_diets  â”‚                    â”‚ grantee_id      â”‚
â”‚ can_edit_trainingsâ”‚                  â”‚ can_edit_diets  â”‚
â”‚ is_active       â”‚                    â”‚ can_edit_trainingsâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚ is_active       â”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Multi-tenant: Todas as tabelas principais tÃªm gym_id
Subscription: Toda gym tem 1 subscription (criada automaticamente com plano inicial)
```

---

## ğŸ”„ Ciclo de Vida de uma RequisiÃ§Ã£o

```
1. Client envia requisiÃ§Ã£o
         â”‚
         â–¼
2. NGINX (Reverse Proxy)
   â€¢ SSL termination
   â€¢ Load balancing
         â”‚
         â–¼
3. AdonisJS Router
   â€¢ Match route pattern
         â”‚
         â–¼
4. Middleware Stack
   â€¢ ForceJsonResponse
   â€¢ ContainerBindings
   â€¢ Rate Limiting
   â€¢ Authentication
         â”‚
         â–¼
5. Validator
   â€¢ Valida dados de entrada
         â”‚
         â–¼
6. Controller
   â€¢ LÃ³gica de negÃ³cio
         â”‚
         â–¼
7. Policy (Bouncer)
   â€¢ Verifica permissÃµes
   â€¢ Multi-tenant checks
         â”‚
         â–¼
8. Service Layer (se necessÃ¡rio)
   â€¢ PermissionService
   â€¢ Business logic complexa
         â”‚
         â–¼
9. Model (Lucid ORM)
   â€¢ Query database
   â€¢ Relationships
         â”‚
         â–¼
10. Database (MySQL)
    â€¢ Execute query
    â€¢ Return results
         â”‚
         â–¼
11. Transform Response
    â€¢ SerializaÃ§Ã£o
    â€¢ JSON formatting
         â”‚
         â–¼
12. Send Response
    â€¢ Status code
    â€¢ Headers
    â€¢ Body
         â”‚
         â–¼
13. Client recebe resposta

â”€â”€ Se erro ocorrer em qualquer ponto â”€â”€
         â”‚
         â–¼
14. Exception Handler
    â€¢ Log error
    â€¢ Send to Sentry
    â€¢ Return error response
```

---

## ğŸ¯ Principais CaracterÃ­sticas

### Multi-tenancy
- Isolamento lÃ³gico via `gym_id`
- Todas queries filtradas por academia
- Cross-tenant via permissÃµes explÃ­citas

### SeguranÃ§a
- Rate limiting em mÃºltiplos nÃ­veis
- Policy-based authorization
- Token authentication
- Senha hasheada (scrypt)

### Observability
- Error monitoring (Sentry)
- Structured logs
- Health check endpoint

### Performance
- Eager loading de relacionamentos
- Ãndices no banco
- Connection pooling
- Cluster mode (PM2)

---

**Ãšltima atualizaÃ§Ã£o:** 17/02/2026  
**VersÃ£o:** 1.1
